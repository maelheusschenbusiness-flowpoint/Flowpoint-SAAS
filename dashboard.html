<!doctype html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FlowPoint AI — Dashboard</title>
  <style>
    body { font-family: system-ui, Arial; background:#f7f7fb; margin:0; }
    .wrap { max-width: 900px; margin: 40px auto; padding: 0 16px; }
    .card { background:#fff; border:1px solid #e7e9f2; border-radius:16px; padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.05); }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .box { flex:1; min-width:220px; border:1px solid #eee; border-radius:14px; padding:14px; background:#fafafa; }
    h1 { margin:0 0 6px; }
    .muted { color:#666; font-size:14px; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#1d4ed8; font-weight:900; font-size:12px; }
    .btn { padding:12px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:900; }
    .btnPrimary { background:#2f5bff; color:#fff; }
    .btnGhost { background:#eef2ff; color:#1d4ed8; }
    .btnDark { background:#111; color:#fff; }
    #msg { margin-top: 12px; font-size: 14px; }
    .error { color:#b00020; }
    .ok { color:#0a7a2f; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <h1>Dashboard</h1>
          <div class="muted">Votre compte FlowPoint AI</div>
        </div>
        <div class="pill" id="planBadge">—</div>
      </div>

      <div style="height:14px"></div>

      <div class="row">
        <div class="box">
          <div class="muted">Email</div>
          <div id="email" style="font-weight:900;">—</div>
        </div>
        <div class="box">
          <div class="muted">Entreprise</div>
          <div id="company" style="font-weight:900;">—</div>
        </div>
        <div class="box">
          <div class="muted">Essai</div>
          <div id="trial" style="font-weight:900;">—</div>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="row">
        <button class="btn btnPrimary" id="portalBtn">Gérer abonnement</button>
        <button class="btn btnGhost" id="upgradeBtn">Upgrade</button>
        <button class="btn btnDark" id="logoutBtn">Déconnexion</button>
      </div>

      <div id="msg"></div>

      <div style="margin-top:16px" class="muted">
        <b>Upgrade :</b> ce bouton ouvre le <b>Portail Stripe</b> (tu peux y activer upgrade/downgrade/annulation).
      </div>
    </div>
  </div>

  <script>
    const msg = document.getElementById("msg");
    const portalBtn = document.getElementById("portalBtn");
    const upgradeBtn = document.getElementById("upgradeBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    function setMsg(text="", type="") {
      msg.textContent = text;
      msg.className = type === "ok" ? "ok" : type === "error" ? "error" : "";
    }

    function fmtDate(d) {
      if (!d) return "—";
      try { return new Date(d).toLocaleString("fr-FR"); } catch { return "—"; }
    }

    async function api(path, opts={}) {
      const token = localStorage.getItem("fp_token");
      if (!token) throw new Error("Non connecté");
      const r = await fetch(path, {
        ...opts,
        headers: {
          ...(opts.headers || {}),
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        }
      });
      const d = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(d.error || "Erreur API");
      return d;
    }

    async function loadMe() {
      setMsg("");
      const token = localStorage.getItem("fp_token");
      if (!token) { location.href = "/login.html"; return; }

      try {
        const d = await api("/api/me");
        document.getElementById("email").textContent = d.email || "—";
        document.getElementById("company").textContent = d.companyName || "—";
        document.getElementById("planBadge").textContent = (d.plan || "—").toUpperCase();
        document.getElementById("trial").textContent = d.hasTrial ? ("Jusqu’au " + fmtDate(d.trialEndsAt)) : "Non démarré";

        if (d.accessBlocked) {
          setMsg("Accès bloqué : paiement échoué. Clique “Gérer abonnement” pour mettre à jour ta carte.", "error");
        }
      } catch (e) {
        localStorage.removeItem("fp_token");
        location.href = "/login.html";
      }
    }

    async function openPortal() {
      setMsg("");
      portalBtn.disabled = true;
      upgradeBtn.disabled = true;
      try {
        const d = await api("/api/stripe/portal", { method: "POST", body: "{}" });
        location.href = d.url;
      } catch (e) {
        setMsg(e.message, "error");
      } finally {
        portalBtn.disabled = false;
        upgradeBtn.disabled = false;
      }
    }

    portalBtn.addEventListener("click", openPortal);

    // Upgrade = ouvre le portail Stripe (meilleure pratique pour gérer upgrades/downgrades)
    upgradeBtn.addEventListener("click", openPortal);

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("fp_token");
      location.href = "/index.html";
    });

    loadMe();
  </script>
</body>
</html>
